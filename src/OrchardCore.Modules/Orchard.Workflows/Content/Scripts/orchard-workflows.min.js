function refreshStateMessage(){$("#activity-editor div").hasClass("start")?$("#start-message").hide():$("#start-message").show()}function displaySaveMessage(){var n=$("#save-message");return n.css("display")==="none"?(n.show(),!0):!1}var connectorPaintStyle={lineWidth:2,strokeStyle:"#999",joinstyle:"round"},connectorHoverStyle={lineWidth:2,strokeStyle:"#225588"},sourceEndpointOptions={endpoint:["Dot",{cssClass:"sourceEndpoint",radius:5}],paintStyle:{fillStyle:"#225588"},isSource:!0,isTarget:!1,deleteEndpointsOnDetach:!1,connector:["Flowchart"],connectorStyle:connectorPaintStyle,hoverPaintStyle:connectorHoverStyle,connectorHoverStyle:connectorHoverStyle,overlays:[["Label",{location:[3,-1.5],cssClass:"sourceEndpointLabel"}]]},createActivity,refreshToolbar,hideToolbar;jsPlumb.bind("ready",function(){jsPlumb.importDefaults({Anchor:"Continuous",DragOptions:{cursor:"pointer",zIndex:2e3},EndpointStyles:[{fillStyle:"#225588"}],Endpoints:[["Dot",{radius:7}],["Blank"]],ConnectionOverlays:[["Arrow",{width:12,length:12,location:-5}],],ConnectorZIndex:5});updateActivities(localId);loadActivities(localId);createToolbar();jsPlumb.bind("jsPlumbConnection",function(){});jsPlumb.bind("jsPlumbConnectionDetached",function(){})});createActivity=function(n,t,i){return renderActivity(null,-1,n,{},!1,t,i)};$(".activity-toolbox-item").draggable({helper:"clone"});$("#activity-editor").droppable({drop:function(n,t){var r=t.draggable.data("activity-name"),i,u;r&&r.length&&(i=$(this).offset(),displaySaveMessage()?createActivity(r,n.pageY-i.top-40,n.pageX-i.left):createActivity(r,n.pageY-i.top,n.pageX-i.left));displaySaveMessage()&&(u=t.position,u.top+=40)}});$("#search-box").focus().on("keyup",function(){var n=$(this).val(),t;n==""?$(".activity-toolbox-item").show():(t=n.toLowerCase(),$(".activity-toolbox-item").each(function(){var n=$(this).data("activity-name").toLowerCase();$(this).toggle(n.indexOf(t)>=0)}))});var renderActivity=function(n,t,r,u,f,e,o){$.ajax({type:"POST",url:renderActivityUrl,data:{name:r,state:u,__RequestVerificationToken:requestAntiForgeryToken},async:!1,success:function(s){var h=$($.parseHTML($.trim(s))),w,c,l,a,v,y,p;if(h==null)return null;for(h.addClass("activity"),$.inArray(t,awaitingRecords)!=-1&&h.addClass("awaiting"),f&&h.addClass("start"),n&&h.attr("id",n),w=$("#activity-editor"),w.append(h),jsPlumb.draggable(h,{containment:"parent",scroll:!0,drag:hideToolbar}),jsPlumb.makeTarget(h,{dropOptions:{hoverClass:"dragHover"},anchor:"Continuous",endpoint:"Blank",paintStyle:{fillStyle:"#558822",radius:3}}),c=h.get(0),c.viewModel={name:r,state:u,start:f,clientId:h.attr("id"),hasForm:activities[r].hasForm},c.endpoints={},l=activities[r].outcomes,h.data("outcomes")&&(l=eval("["+h.data("outcomes")+"]")),i=0;i<l.length;i++)a=jsPlumb.addEndpoint(h,{anchor:"Continuous",connectorOverlays:[["Label",{label:l[i].Label,cssClass:"connection-label"}]]},sourceEndpointOptions),c.endpoints[l[i].Id]=a,a.outcome=l[i];activities[r].hasForm&&(v=function(){saveLocal(localId);window.location.href=editActivityUrl+"/"+$("#id").val()+"?name="+r+"&clientId="+c.viewModel.clientId+"&localId="+localId},h.dblclick(v),c.viewModel.edit=v);y=$("#activity-editor").width();p=$("#"+n).width()+25;h.css("top",e+"px");h.css("left",o+p>y?y-p:o+"px");jsPlumb.repaint(c.viewModel.clientId);h.on("click",function(){var t=$(this),n=$("#activity-toolbar");return refreshToolbar(this),n.position({my:"right bottom",at:"right top",offset:"0 -5",of:t,collision:"none"}),n.get(0).target=this,n.show(),!1})}})},createToolbar=function(){var n=$("#activity-editor");n.on("click",function(){hideToolbar()});initToolbar()},initToolbar=function(){$("#activity-toolbar-start-checkbox").change(function(){var i=$("#activity-toolbar"),n=$(i).get(0).target,t=$(this).is(":checked");n.viewModel.start=t;$(n).toggleClass("start",t);refreshStateMessage();displaySaveMessage()});$("#activity-toolbar-start").click(function(n){n.stopPropagation()})};refreshToolbar=function(n){var t,i;n=$(n);$("#activity-toolbar-start").toggle(n.hasClass("canStart"));$("#activity-toolbar-start-checkbox").prop("checked",n.get(0).viewModel.start);t=$("#activity-toolbar-edit");n.get(0).viewModel.hasForm?(t.unbind("click").click(n.get(0).viewModel.edit),t.toggle(!0)):t.toggle(!1);i=$("#activity-toolbar-delete");i.unbind("click").click(function(){if(!confirm($("#confirm-delete-activity").val()))return!1;jsPlumb.removeAllEndpoints(n.attr("id"));n.remove();displaySaveMessage()})};hideToolbar=function(){var n=$("#activity-toolbar");n.offset({top:0,left:0});n.hide()};